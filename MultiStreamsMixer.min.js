// Last time updated: 2024-06-26 6:12:33 PM UTC

// ________________________
// MultiStreamsMixer v1.2.3

// Open-Sourced: https://github.com/muaz-khan/MultiStreamsMixer

// --------------------------------------------------
// Muaz Khan     - www.MuazKhan.com
// MIT License   - www.WebRTC-Experiment.com/licence
// --------------------------------------------------

function MultiStreamsMixer(arrayOfMediaStreams,elementClass){function setSrcObject(stream,element){"srcObject"in element?element.srcObject=stream:"mozSrcObject"in element?element.mozSrcObject=stream:element.srcObject=stream}function drawVideosToCanvas(){if(!isStopDrawingFrames){canvas.width=self.width||360,canvas.height=self.height||240;var fullcanvas=!1,remaining=[];videos.forEach(function(video){video.stream||(video.stream={}),video.stream.fullcanvas?fullcanvas=video:remaining.push(video)});var videosLength=remaining.length;const canvasWidth=canvas.width,canvasHeight=canvas.height,videosPerRow=videosLength<=Math.sqrt(videosLength)?videosLength:Math.ceil(Math.sqrt(videosLength)),videosPerColumn=Math.ceil(videosLength/videosPerRow),cols=Math.min(videosPerRow,videosLength),rows=videosPerColumn,videoWidth=canvasWidth/cols,videoHeight=canvasHeight/rows;for(var videoIndex=0,row=0;row<rows&&videoIndex<videosLength;row++)for(var col=0;col<cols&&videoIndex<videosLength;col++){const video=remaining[videoIndex],x=col*videoWidth,y=row*videoHeight;drawVideo(video,x,y,videoWidth,videoHeight),drawTextOnVideo(video,video.stream.nickname,videoIndex,videosPerRow,videosPerColumn),videoIndex++}setTimeout(drawVideosToCanvas,self.frameInterval)}}function drawVideo(video,x,y,width,height){const ratio=Math.min(width/video.width,height/video.height),displayWidth=video.width*ratio,displayHeight=video.height*ratio;context.drawImage(video,x,y,displayWidth,displayHeight),"function"==typeof video.stream.onRender&&video.stream.onRender(context,x,y,displayWidth,displayHeight)}function drawTextOnVideo(video,textToDisplay,idx,videosPerRow,videosPerColumn){video.stream.onRender=function(context,x,y,width,height,idx){context.font="50px Roboto";const measuredTextWidth=context.measureText(textToDisplay).width,measuredTextHeight=parseInt(context.font,10),textX=x+10,textY=y+height-10;context.strokeStyle="rgb(255, 255, 255)",context.fillStyle="rgba(0, 0, 0, .5)",context.fillRect(textX,textY-measuredTextHeight,measuredTextWidth+20,measuredTextHeight+10),context.fillStyle="rgb(255, 255, 255)",context.fillText(textToDisplay,textX+10,textY)}}function getMixedStream(){isStopDrawingFrames=!1;var mixedVideoStream=getMixedVideoStream(),mixedAudioStream=getMixedAudioStream();mixedAudioStream&&mixedAudioStream.getTracks().filter(function(t){return"audio"===t.kind}).forEach(function(track){mixedVideoStream.addTrack(track)});var fullcanvas;return arrayOfMediaStreams.forEach(function(stream){stream.fullcanvas&&(fullcanvas=!0)}),mixedVideoStream}function getMixedVideoStream(){resetVideoStreams();var capturedStream;"captureStream"in canvas?capturedStream=canvas.captureStream():"mozCaptureStream"in canvas?capturedStream=canvas.mozCaptureStream():self.disableLogs||console.error("Upgrade to latest Chrome or otherwise enable this flag: chrome://flags/#enable-experimental-web-platform-features");var videoStream=new MediaStream;return capturedStream.getTracks().filter(function(t){return"video"===t.kind}).forEach(function(track){videoStream.addTrack(track)}),canvas.stream=videoStream,videoStream}function getMixedAudioStream(){return self.audioSources=[],self.audioDestination||(self.audioDestination=self.audioContext.createMediaStreamDestination(),console.log("ðŸš€ ~ getMixedAudioStream CREATE NEW ~ self.audioDestination:",self.audioDestination)),self.audioDestination.stream}function getVideo(stream){var video=document.createElement("video");return setSrcObject(stream,video),video.className=elementClass,video.muted=!0,video.volume=0,video.width=stream.width||self.width||360,video.height=stream.height||self.height||240,video.play(),video}function resetVideoStreams(streams,type){streams=streams||arrayOfMediaStreams,videos=[],arrayOfMediaStreams=[];var activeAudios=[];streams.forEach(function(stream){if(arrayOfMediaStreams.push(stream),stream.getTracks().filter(function(t){return"video"===t.kind}).length){console.log("ðŸš€ ~ streams video forEach ~ t:",stream);var video=getVideo(stream);video.stream=stream,videos.push(video)}if(stream.getTracks().filter(function(t){return"audio"===t.kind}).length)try{console.log("ðŸš€ ~ streams audio forEach ~ t:",stream);var activeAudio=audios.filter(function(a){return console.log("ðŸš€ ~ audios.filter ~ a:",a),a.audioSource.mediaStream===stream});activeAudio&&activeAudios.push(activeAudio)}catch(error){console.error("ERROR FATALE: ",error)}});var removedAudios=audios.filter(function(audio){return!activeAudios.some(function(audioStream){return audio.audioSource.mediaStream===audioStream})});"audio"===type&&(audios=activeAudios,console.log("ðŸš€ ~ [END ] resetVideoStreams ~ audios:",audios),removedAudios.forEach(function(audio){console.log(typeof audio.gainNode),console.log("ðŸš€ ~ audios.forEach ~ gainNode:",audio.gainNode),audio.gainNode.gain.value=0;try{audio.gainNode.disconnect(self.audioDestination)}catch(error){console.error(error)}}))}var browserFakeUserAgent="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";!function(that){"undefined"==typeof RecordRTC&&that&&"undefined"==typeof window&&"undefined"!=typeof global&&(global.navigator={userAgent:browserFakeUserAgent,getUserMedia:function(){}},global.console||(global.console={}),"undefined"!=typeof global.console.log&&"undefined"!=typeof global.console.error||(global.console.error=global.console.log=global.console.log||function(){console.log(arguments)}),"undefined"==typeof document&&(that.document={documentElement:{appendChild:function(){return""}}},document.createElement=document.captureStream=document.mozCaptureStream=function(){var obj={getContext:function(){return obj},play:function(){},pause:function(){},drawImage:function(){},toDataURL:function(){return""},style:{}};return obj},that.HTMLVideoElement=function(){}),"undefined"==typeof location&&(that.location={protocol:"file:",href:"",hash:""}),"undefined"==typeof screen&&(that.screen={width:0,height:0}),"undefined"==typeof URL&&(that.URL={createObjectURL:function(){return""},revokeObjectURL:function(){return""}}),that.window=global)}("undefined"!=typeof global?global:null),this.disableLogs=!1,this.frameInterval=33,this.width=1920,this.height=1080,this.useGainNode=!0,elementClass=elementClass||"multi-streams-mixer";var videos=[],audios=[],isStopDrawingFrames=!1,canvas=document.createElement("canvas"),context=canvas.getContext("2d");canvas.style.opacity=0,canvas.style.position="absolute",canvas.style.zIndex=-1,canvas.style.top="-1000em",canvas.style.left="-1000em",canvas.className=elementClass,(document.body||document.documentElement).appendChild(canvas);var self=this,AudioContext=window.AudioContext;"undefined"==typeof AudioContext&&("undefined"!=typeof webkitAudioContext&&(AudioContext=webkitAudioContext),"undefined"!=typeof mozAudioContext&&(AudioContext=mozAudioContext));var URL=window.URL;"undefined"==typeof URL&&"undefined"!=typeof webkitURL&&(URL=webkitURL),"undefined"!=typeof navigator&&"undefined"==typeof navigator.getUserMedia&&("undefined"!=typeof navigator.webkitGetUserMedia&&(navigator.getUserMedia=navigator.webkitGetUserMedia),"undefined"!=typeof navigator.mozGetUserMedia&&(navigator.getUserMedia=navigator.mozGetUserMedia));var MediaStream=window.MediaStream;"undefined"==typeof MediaStream&&"undefined"!=typeof webkitMediaStream&&(MediaStream=webkitMediaStream),"undefined"!=typeof MediaStream&&"undefined"==typeof MediaStream.prototype.stop&&(MediaStream.prototype.stop=function(){this.getTracks().forEach(function(track){track.stop()})});var Storage={};"undefined"!=typeof AudioContext?Storage.AudioContext=AudioContext:"undefined"!=typeof webkitAudioContext&&(Storage.AudioContext=webkitAudioContext),Storage.AudioContextConstructor||(Storage.AudioContextConstructor=new Storage.AudioContext),self.audioContext=Storage.AudioContextConstructor,console.log("self.audioContext",self.audioContext),this.startDrawingFrames=function(){drawVideosToCanvas()},this.appendStreams=function(streams){if(!streams)throw"First parameter is required.";streams instanceof Array||(streams=[streams]),streams.forEach(function(stream){arrayOfMediaStreams.push(stream);new MediaStream;if(stream.getTracks().filter(function(t){return"video"===t.kind}).length){var video=getVideo(stream);video.stream=stream,videos.push(video)}if(stream.getTracks().filter(function(t){return"audio"===t.kind}).length){var gainNode=self.audioContext.createGain();gainNode.gain.value=1;var audioSource=self.audioContext.createMediaStreamSource(stream);try{var audioSourceConnect=audioSource.connect(gainNode);console.warn("audioSourceConnect: ",audioSourceConnect)}catch(error){console.error(error)}console.log("ðŸš€ ~ streams.forEach ~ audioSource:",audioSource),self.audioDestination||(self.audioDestination=self.audioContext.createMediaStreamDestination(),console.log("ðŸš€ ~ streams.forEach CREATE NEW ~ self.audioDestination:",self.audioDestination));try{var gainAudioDestination=gainNode.connect(self.audioDestination);console.warn("gainAudioDestination: ",gainAudioDestination)}catch(error){console.error(error)}audios.push({gainNode:gainNode,audioSource:audioSource})}})},this.releaseStreams=function(){videos=[],isStopDrawingFrames=!0,self.gainNode&&(self.gainNode.disconnect(),self.gainNode=null),self.audioSources.length&&(self.audioSources.forEach(function(source){source.disconnect()}),self.audioSources=[]),self.audioDestination&&(self.audioDestination.disconnect(),self.audioDestination=null),self.audioContext&&self.audioContext.close(),self.audioContext=null,context.clearRect(0,0,canvas.width,canvas.height),canvas.stream&&(canvas.stream.stop(),canvas.stream=null)},this.resetVideoStreams=function(streams,type){!streams||streams instanceof Array||(streams=[streams]),resetVideoStreams(streams,type)},this.name="MultiStreamsMixer",this.toString=function(){return this.name},this.getMixedStream=getMixedStream}"undefined"==typeof RecordRTC&&("undefined"!=typeof module&&(module.exports=MultiStreamsMixer),"function"==typeof define&&define.amd&&define("MultiStreamsMixer",[],function(){return MultiStreamsMixer}));